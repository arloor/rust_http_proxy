<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>{{ hostname }}ÁΩëÈÄü</title>
  <style>
    html,
    body {
      margin: 0;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: linear-gradient(135deg, #5f72bd 0%, #9921e8 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 100;
    }

    .backend-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-size: 14px;
      flex: 1;
    }

    .backend-label {
      font-weight: 600;
      opacity: 0.9;
    }

    .backend-value {
      font-family: 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chart-container {
      flex: 1;
      width: 100%;
      overflow: hidden;
    }

    .chart-main {
      width: 100%;
      height: 100%;
    }

    .in {
      padding: 10px;
      margin: 0;
      font-family: "JetBrains Mono", "SFMono-Regular", "SF-Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Roboto Mono", "Ubuntu Mono", "Courier New", Courier, monospace;
    }

    .settings-button {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.25);
      color: white;
      border: 1.5px solid rgba(255, 255, 255, 0.4);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .settings-button:hover {
      background: rgba(255, 255, 255, 0.35);
      border-color: rgba(255, 255, 255, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .settings-button:active {
      transform: translateY(0);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }

    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    .modal-input:focus {
      outline: none;
      border-color: #007bff;
    }

    .saved-list {
      margin-top: 8px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background: #fff;
    }

    .saved-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
    }

    .saved-item:last-child {
      border-bottom: none;
    }

    .saved-item:hover {
      background: #f8f9fa;
      padding-left: 18px;
    }

    .saved-item.active {
      background: linear-gradient(90deg, #e7f3ff 0%, #f0f8ff 100%);
      border-left: 4px solid #007bff;
      padding-left: 14px;
      font-weight: 600;
    }

    .saved-item-text {
      flex: 1;
      font-size: 14px;
      color: #2c3e50;
      font-family: 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
      font-weight: 500;
      line-height: 1.6;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      letter-spacing: 0.3px;
    }

    .saved-item-delete {
      padding: 4px 8px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 8px;
      transition: background 0.2s;
    }

    .saved-item-delete:hover {
      background: #c82333;
    }

    .empty-list {
      padding: 30px 20px;
      text-align: center;
      color: #6c757d;
      font-size: 14px;
      font-style: italic;
    }

    .button-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .save-current-button {
      flex: 1;
      padding: 8px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .save-current-button:hover {
      background: #218838;
    }

    .save-current-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .use-current-button {
      flex: 1;
      padding: 8px;
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .use-current-button:hover {
      background: #138496;
    }

    .current-url {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      padding: 14px 16px;
      border-radius: 8px;
      font-size: 14px;
      color: #1a1a1a;
      word-break: break-all;
      font-family: 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
      font-weight: 600;
      line-height: 1.7;
      letter-spacing: 0.5px;
      border: 1px solid #dee2e6;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
      justify-content: flex-end;
    }

    .modal-button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .modal-button-primary {
      background: #007bff;
      color: white;
    }

    .modal-button-primary:hover {
      background: #0056b3;
    }

    .modal-button-secondary {
      background: #6c757d;
      color: white;
    }

    .modal-button-secondary:hover {
      background: #5a6268;
    }

    .modal-button-danger {
      background: #dc3545;
      color: white;
    }

    .modal-button-danger:hover {
      background: #c82333;
    }
  </style>
  <script
    src="https://us.arloor.dev/https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
  <script
    src="https://us.arloor.dev/https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
  <!-- use babel to transform your JSX code into regular JavaScript. -->
  <script
    src="https://us.arloor.dev/https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.1/babel.min.js"></script>

  <!--   <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> -->
  <script src="https://us.arloor.dev/https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
  <!-- <script src="https://www.arloor.com/echarts.min.js"></script> -->
</head>

<body>
  <div id="app"></div>

  <script type="text/jsx">
        const API_PATH = '/net.json';  // Âõ∫ÂÆöÁöÑ API Ë∑ØÂæÑ
        const SAVED_BACKENDS_KEY = 'saved_backends';  // localStorage ÈîÆÂêç

        const query = new URLSearchParams(window.location.search);
        let initialBackendUrl = query.get('backend'); // ‰ªé URL ÂèÇÊï∞ËØªÂèñÂêéÁ´ØÂú∞ÂùÄ

        // Â∞ùËØï‰ªé localStorage ËØªÂèñ‰øùÂ≠òÁöÑÂêéÁ´ØÂú∞ÂùÄ
        const savedBackend = localStorage.getItem('backend_url');
        if (savedBackend) {
          initialBackendUrl = savedBackend;
        }

        // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÂêéÁ´ØÂú∞ÂùÄÔºå‰ΩøÁî®Á©∫Â≠óÁ¨¶‰∏≤Ë°®Á§∫ÂΩìÂâçÂüüÂêç
        if (!initialBackendUrl) {
          initialBackendUrl = '';
        }

        // ‰ªé localStorage ËØªÂèñÂ∑≤‰øùÂ≠òÁöÑÂêéÁ´ØÂú∞ÂùÄÂàóË°®
        function loadSavedBackends() {
          try {
            const saved = localStorage.getItem(SAVED_BACKENDS_KEY);
            return saved ? JSON.parse(saved) : [];
          } catch {
            return [];
          }
        }

        // ‰øùÂ≠òÂêéÁ´ØÂú∞ÂùÄÂàóË°®Âà∞ localStorage
        function saveSavedBackends(backends) {
          localStorage.setItem(SAVED_BACKENDS_KEY, JSON.stringify(backends));
        }

        function App() {
          const [backendUrl, setBackendUrl] = React.useState(initialBackendUrl);
          const [showModal, setShowModal] = React.useState(false);
          const [tempBackendUrl, setTempBackendUrl] = React.useState(initialBackendUrl);
          const [savedBackends, setSavedBackends] = React.useState(loadSavedBackends());

          // Ê†πÊçÆÂêéÁ´ØÂú∞ÂùÄÊûÑÂª∫ÂÆåÊï¥ÁöÑÊï∞ÊçÆ URL
          const dataUrl = React.useMemo(() => {
            const backend = backendUrl.trim();
            if (!backend) {
              // Á©∫Â≠óÁ¨¶‰∏≤Ë°®Á§∫‰ΩøÁî®ÂΩìÂâçÂüüÂêç
              return API_PATH;
            }
            // ÁßªÈô§Êú´Â∞æÁöÑÊñúÊù†
            const cleanBackend = backend.replace(/\/+$/, '');
            return cleanBackend + API_PATH;
          }, [backendUrl]);

          React.useEffect(() => {
            const mainDiv = document.getElementById('main');
            let myChart = echarts.init(mainDiv);
            myChart.showLoading();
            window.addEventListener('resize', myChart.resize);
            refresh(myChart, dataUrl);

            const intervalId = setInterval(() => {
              refresh(myChart, dataUrl);
            }, 5000); // ÊØè5ÁßíÊâßË°å‰∏ÄÊ¨°

            // Ê∏ÖÈô§ÂÆöÊó∂Âô®
            return () => {
              clearInterval(intervalId)
              window.removeEventListener('resize', myChart.resize);
              myChart.dispose();
            };
          }, [dataUrl]);

          const handleOpenModal = () => {
            setTempBackendUrl(backendUrl);
            setShowModal(true);
          };

          const handleCloseModal = () => {
            setShowModal(false);
          };

          const handleSave = () => {
            setBackendUrl(tempBackendUrl);
            localStorage.setItem('backend_url', tempBackendUrl);
            setShowModal(false);
          };

          const handleReset = () => {
            setTempBackendUrl('');
          };

          const handleSaveToList = () => {
            const trimmedUrl = tempBackendUrl.trim();
            if (!trimmedUrl) {
              alert('ËØ∑ËæìÂÖ•ÂêéÁ´ØÂú∞ÂùÄ');
              return;
            }
            if (savedBackends.includes(trimmedUrl)) {
              alert('ËØ•Âú∞ÂùÄÂ∑≤Â≠òÂú®');
              return;
            }
            const newBackends = [...savedBackends, trimmedUrl];
            setSavedBackends(newBackends);
            saveSavedBackends(newBackends);
          };

          const handleUseCurrent = () => {
            setTempBackendUrl('');
          };

          const handleSelectSaved = (url) => {
            setTempBackendUrl(url);
          };

          const handleDeleteSaved = (url, e) => {
            e.stopPropagation();
            const newBackends = savedBackends.filter(b => b !== url);
            setSavedBackends(newBackends);
            saveSavedBackends(newBackends);
          };

          const handleModalKeyPress = (e) => {
            if (e.key === 'Enter') {
              handleSave();
            } else if (e.key === 'Escape') {
              handleCloseModal();
            }
          };

          return (
            <div className='app-container'>
              <div className='top-bar'>
                <div className='backend-info'>
                  <span className='backend-label'>ÂΩìÂâçÂêéÁ´Ø:</span>
                  <span className='backend-value' title={backendUrl || 'ÂΩìÂâçÂüüÂêç'}>
                    {backendUrl || 'ÂΩìÂâçÂüüÂêç'}
                  </span>
                </div>
                <button className='settings-button' onClick={handleOpenModal}>
                  ‚öôÔ∏è ÂêéÁ´ØËÆæÁΩÆ
                </button>
              </div>

              <div className='chart-container'>
                <div id='main' className='chart-main'></div>
              </div>

              {showModal && (
                <div className='modal-overlay' onClick={handleCloseModal}>
                  <div className='modal-content' onClick={(e) => e.stopPropagation()}>
                    <div className='modal-header'>
                      ÂêéÁ´ØÂú∞ÂùÄËÆæÁΩÆ
                    </div>

                    <div className='modal-section'>
                      <label className='modal-label'>ÂêéÁ´ØÂú∞ÂùÄ</label>
                      <input
                        className='modal-input'
                        type="text"
                        value={tempBackendUrl}
                        onChange={(e) => setTempBackendUrl(e.target.value)}
                        onKeyDown={handleModalKeyPress}
                        placeholder="ÁïôÁ©∫‰ΩøÁî®ÂΩìÂâçÂüüÂêçÔºåÊàñËæìÂÖ•Â¶Ç: https://us.arloor.dev"
                        autoFocus
                      />
                      <div className='button-group'>
                        <button
                          className='save-current-button'
                          onClick={handleSaveToList}
                          disabled={!tempBackendUrl.trim() || savedBackends.includes(tempBackendUrl.trim())}
                        >
                          üíæ ‰øùÂ≠òÊ≠§Âú∞ÂùÄÂà∞ÂàóË°®
                        </button>
                        <button
                          className='use-current-button'
                          onClick={handleUseCurrent}
                        >
                          üè† ‰ΩøÁî®ÂΩìÂâçÊúçÂä°Âô®
                        </button>
                      </div>
                    </div>

                    <div className='modal-section'>
                      <label className='modal-label'>Â∑≤‰øùÂ≠òÁöÑÂêéÁ´ØÂú∞ÂùÄ</label>
                      <div className='saved-list'>
                        {savedBackends.length === 0 ? (
                          <div className='empty-list'>ÊöÇÊó†‰øùÂ≠òÁöÑÂú∞ÂùÄ</div>
                        ) : (
                          savedBackends.map((url) => (
                            <div
                              key={url}
                              className={`saved-item ${tempBackendUrl === url ? 'active' : ''}`}
                              onClick={() => handleSelectSaved(url)}
                            >
                              <div className='saved-item-text' title={url}>
                                {url || 'ÂΩìÂâçÂüüÂêç'}
                              </div>
                              <button
                                className='saved-item-delete'
                                onClick={(e) => handleDeleteSaved(url, e)}
                              >
                                Âà†Èô§
                              </button>
                            </div>
                          ))
                        )}
                      </div>
                    </div>

                    <div className='modal-section'>
                      <label className='modal-label'>ÂΩìÂâçËØ∑Ê±Ç URL</label>
                      <div className='current-url'>
                        {tempBackendUrl ? tempBackendUrl.replace(/\/+$/, '') + API_PATH : API_PATH}
                      </div>
                    </div>

                    <div className='modal-actions'>
                      <button className='modal-button modal-button-danger' onClick={handleReset}>
                        ÈáçÁΩÆ
                      </button>
                      <button className='modal-button modal-button-secondary' onClick={handleCloseModal}>
                        ÂèñÊ∂à
                      </button>
                      <button className='modal-button modal-button-primary' onClick={handleSave}>
                        Â∫îÁî®
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }
        const refresh = (myChart, url) => fetch(url)
          .then(res => res.json()).then(data => {
            // console.log("net.json is", new Date(), JSON.stringify(data));
            var xAxisData = data.scales;
            if (data.scales.length === 0) {
              myChart.showLoading();
              return;
            }
            myChart.hideLoading();
            let series = []
            data.series_vec.forEach(ele => {
              let tmpSeries = {
                ...baseSeries,
                "data": ele.data,
                "name": ele.name,
              };
              if (ele.show_avg_line) {
                tmpSeries.markLine = avgMarkLine;
              }
              if (ele.show_max_point) {
                tmpSeries.markPoint = maxMarkPoint;
              }
              if (ele.color) {
                tmpSeries.itemStyle = {
                  color: ele.color,
                }
              }
              if (ele.type) {
                tmpSeries.type = ele.type
              }
              series.push(tmpSeries);
            });
            let max = series.map(s => s.data).flat().reduce((a, b) => Math.max(a, b));
            var c = Math.floor(Math.log(max) / Math.log(1024));
            let interval = Math.pow(1024, c);
            while (max / interval > 10) {
              interval *= 2;
            }
            // console.log("interval is", formatDataRateIEC(interval));
            // ÊåáÂÆöÂõæË°®ÁöÑÈÖçÁΩÆÈ°πÂíåÊï∞ÊçÆ
            var option = {
              color: ['#667eea', '#9921e8', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0'],
              title: {
                text: ''
              },
              tooltip: {
                trigger: 'axis',
                formatter: series => {
                  return series[0].name + series.map(s => '<br/>' + s.seriesName + ': ' + formatDataRateIEC(s.value, 4)).join('');
                },
                backgroundColor: 'rgba(50, 50, 50, 0.9)',
                borderColor: '#667eea',
                borderWidth: 1,
                textStyle: {
                  color: '#fff'
                }
              },
              legend: {
                data: series.map(s => s.name),
                textStyle: {
                  color: '#666'
                }
              },
              toolbox: {
                feature: {
                  mark: {
                    show: true
                  },
                  dataView: {
                    show: true,
                    readOnly: false
                  },
                  magicType: {
                    show: true,
                    type: ['line', 'bar']
                  },
                  restore: {
                    show: true
                  },
                  saveAsImage: {
                    show: true
                  }
                }
              },
              xAxis: {
                type: 'category',
                boundaryGap: false,
                data: xAxisData
              },
              yAxis: {
                type: "value",
                max: value => Math.ceil(value.max / interval) * interval,
                interval: interval,
                axisLabel: {
                  formatter: (value, index) => formatDataRateIEC(value)
                },
                axisLine: {
                  show: true,
                },
                axisTick: {
                  show: true,
                }
              },
              series: series,
              animation: false,
              animationDuration: 5
            };
            // ‰ΩøÁî®ÂàöÊåáÂÆöÁöÑÈÖçÁΩÆÈ°πÂíåÊï∞ÊçÆÊòæÁ§∫ÂõæË°®„ÄÇ
            myChart.setOption(option);
          }).catch(e => {
            console.error("Êõ¥Êñ∞Â§±Ë¥•", e);
            myChart.showLoading();
          });
        
        const baseSeries = {
          // itemStyle: {
          //     color: '#ef0000',
          // },
          "smooth": true,
          "type": "line"
        }
        
        const maxMarkPoint = {
          "data": [{
            "type": "max",
            "name": "ÊúÄÂ§ßÂÄº"
          }],
          symbol: "roundRect",
          symbolSize: [70, 30],
          "label": {
            formatter: value => formatDataRateIEC(value.value, 4)
          }
        }
        const avgMarkLine = {
          "data": [{
            "type": "average",
            "name": "Âπ≥ÂùáÂÄº"
          }],
          "label": {
            formatter: value => formatDataRateIEC(value.value, 4)
          }
        };
        
        
        function formatDataRateIEC(num, precision = -1) {
          let value = null;
          if (num <= 0) {
            value = '0b/s';
          } else {
            var k = 1024;
            var sizes = ['b/s', 'Kb/s', 'Mb/s', 'Gb/s', 'Tb/s', 'Pb/s', 'Eb/s', 'Zb/s', 'Yb/s'];
            //ËøôÈáåÊòØÂèñËá™ÁÑ∂ÂØπÊï∞Ôºå‰πüÂ∞±ÊòØlogÔºàkÔºâÔºànumÔºâÔºåÊ±ÇÂá∫‰ª•k‰∏∫Â∫ïÁöÑÂ§öÂ∞ëÊ¨°ÊñπÊòØnum
            var c = Math.floor(Math.log(num) / Math.log(k));
            if (precision === -1) {
              value = (num / Math.pow(k, c)) + ' ' + sizes[c];
            } else {
              value = (num / Math.pow(k, c)).toPrecision(precision) + ' ' + sizes[c];
            }
          }
          return value;
        }
        
        window.onload = ()=> {
          const app = document.getElementById("app")
          const root = ReactDOM.createRoot(app);
          root.render(<App />);
        };
      </script>
</body>

</html>